String.prototype.trim=function(){return this.replace(/\s/g,"")};var markerclick=false;var map=null;var markerleng=[];var zoomLevel=0;var regmarker=null;var registerForm=('<h1 id="firstHeading" class="firstHeading" lang="ko"><span dir="auto">마커 등록</span></h1>'+'<form>'+'등록자명:<input type="text" name="by">'+'라벨 문서명:<input type="text" name="LocName"><br />'+'연결될 문서명:<input type="text" name="DocName"><br />'+'분류:<input type="text" name="GrpName" placeholder="여러 개 구분은 세미콜론(;)으로 합니다."><br />'+'줌 수준:&nbsp;&nbsp;<label><input type="radio" name="Zoom" value="1">최대&nbsp;&nbsp;</label>'+'<label><input type="radio" name="Zoom" value="2">대&nbsp;&nbsp;</label>'+'<label><input type="radio" name="Zoom" value="3">중&nbsp;&nbsp;</label>'+'<label><input type="radio" name="Zoom" value="4">소&nbsp;&nbsp;</label>'+'<a href="/help.html" target="_blank">도움말</a></br>'+'마커는 퍼블릭 도메인으로 배포됩니다.'+'<button type="button" id="submit_button">등록!</button>'+'</form>');var correctForm=('<h1 id="firstHeading" class="firstHeading" lang="ko"><span dir="auto">마커 수정</span></h1>'+'<form>'+'라벨 문서명:<input type="text" name="C_LocName"><br />'+'연결될 문서명:<input type="text" name="C_DocName"><br />'+'분류:<input type="text" name="C_GrpName" placeholder="여러 개 구분은 세미콜론(;)으로 합니다."><br />'+'줌 수준:&nbsp;&nbsp;<label><input type="radio" name="C_Zoom" value="1">최대&nbsp;&nbsp;</label>'+'<label><input type="radio" name="C_Zoom" value="2">대&nbsp;&nbsp;</label>'+'<label><input type="radio" name="C_Zoom" value="3">중&nbsp;&nbsp;</label>'+'<label><input type="radio" name="C_Zoom" value="4">소&nbsp;&nbsp;</label>'+'<a href="/help.html" target="_blank">도움말</a></br>'+'마커는 퍼블릭 도메인으로 배포됩니다.'+'<button type="button" id="C_submit_button">편집!</button>'+'</form>');var noticeText=('<br>'+'<h1 id="firstHeading" class="firstHeading" lang="ko"><span dir="auto">리브레 맵스 공지</span></h1>'+'<p>리브레 맵스는 <a href="https://librewiki.net/">리브레 위키</a>의 자료를 이용하여 지도를 만들어 나가는 프로젝트입니다.'+'<p>새 마커를 등록하려면 원하는 위치에서 오른쪽 클릭을 해 주세요.</p>'+'<p>피드백은 <a href="https://issue.librewiki.net/">이슈 트래커</a> 또는 메일 nessunkim@gmail.com, <a href="https://librewiki.net/wiki/%EC%82%AC%EC%9A%A9%EC%9E%90%ED%86%A0%EB%A1%A0:Nessun">리브레 위키 사용자토론</a>에서 받습니다.</p>'+'<p><a href="/m/">모바일(등록은 불가)</a></p>'+'<p><a href="/help.html"> 도움말 보기 </a></p>'+'</div>');var mobile=false;function initialize(){var a={zoom:3,disableDefaultUI:false,center:new google.maps.LatLng(37.555107,126.970691)};map=new google.maps.Map(document.getElementById('map-canvas'),a);google.maps.event.addListener(map,'rightclick',registerMarkers);markers=getMarkers();google.maps.event.addListener(map,'idle',zoomWithMarkers);geocoder=new google.maps.Geocoder();getgroups()}google.maps.event.addDomListener(window,'load',initialize);function showeffect(){if(mobile){$('#map-canvas').outerWidth('10%');$('#right-side').outerWidth('89.8%')}else{$('#map-canvas').outerWidth('60%');$('#right-side').outerWidth('39.8%')}var a={direction:"right"};$('#right-side').show("slide",a,500);google.maps.event.trigger(map,'resize')}function getback(){var a={direction:"right"};$('#right-side').hide();$('#map-canvas').width('100%')}function registerMarkers(e){showeffect();if(regmarker)regmarker.setMap(null);regmarker=new MarkerWithLabel({position:e.latLng,map:map,labelContent:"마커 등록중...",labelAnchor:new google.maps.Point(30,70),labelClass:"labels",labelInBackground:false,zIndex:5000});$('#data').html(registerForm);$('#submit_button').unbind("click");$('#submit_button').click(function(){$('#submit_button').unbind("click");var b=$('input[name=by]').val();var c=$('input[name=LocName]').val();var d=$('input[name=DocName]').val();var f=$(':checked[name=Zoom]').val();var g=$('input[name=GrpName]').val();if(b.trim()==''||c.trim()==''||d.trim()==''||$(':checked[name=Zoom]').length==0){alert("분류 이외의 모든 항목은 필수입니다.")}else{$.ajax({url:'/data/register_marker.php',type:'POST',data:{by:b,LocName:c,DocName:d,Zoom:f,GroupText:g,Lat:e.latLng.lat(),Lng:e.latLng.lng()}}).done(function(a){location.reload()})}regmarker.setMap(null)})}function getgroups(){$.ajax({url:'/data/get_groups.php',type:'POST',dataType:'json'}).done(function(a){for(var i in a){$('#groupselect').append("<option value='"+a[i].name+"'>"+a[i].name+"</option>")}});$('#groupselect').change(function(){if($('#groupselect').val()==9999){zoomWithMarkers(true)}else{for(var j=1;j<5;j++){for(var i=0;i<markerleng[j];i++){var a=markers[j][i].grpnums.split(';');if(a.indexOf($('#groupselect').val())!=-1){markers[j][i].setVisible(true)}else{markers[j][i].setVisible(false)}}}}})}function getMarkers(){var o=[[],[],[],[],[]];$.ajax({url:'/data/marker_data.php',type:'POST',dataType:'json',async:false}).done(function(l){for(var j=1;j<5;++j){var m=l[j];var n=m.length;for(var i=0;i<n;i++){o[j].push(marker=new MarkerWithLabel({position:new google.maps.LatLng(m[i].Lat,m[i].Lng),map:map,zoomLv:j,num:m[i].ID,title:m[i].Dn,doc:m[i].Dn,by:m[i].By,grpnums:m[i].Grp,labelContent:m[i].Ln,labelAnchor:new google.maps.Point(30,70),labelClass:"labels",labelInBackground:false,zIndex:(10-j)*100}));marker.setVisible(false);google.maps.event.addListener(marker,"click",function(){markerclick=true;$('#mobile-view_on').css("z-index","999999");var f=this.num;var g=this.position;var h=this.doc;var i=this.labelContent;var j=this.zoomLv;var k=this.grpnums;if(regmarker)regmarker.setMap(null);$.ajax({url:'/data/get_libre_document.php',type:'POST',dataType:'html',data:{pname:this.doc,cont:this.by}}).done(function(e){$('#right-side').scrollTop(0);showeffect();$('#data').html(e);$('.corr_marker').unbind();$('.corr_marker').click(function(){$('#data').html(correctForm);$('input[name=C_LocName]').val(i);$('input[name=C_DocName]').val(h);$('input[name=C_GrpName]').val(k);if(k==';')$('input[name=C_GrpName]').val('');$('[name=C_Zoom][value='+j+']').attr('checked',true);$('#C_submit_button').unbind("click");$('#C_submit_button').click(function(){$('#C_submit_button').unbind("click");var a=$('input[name=C_LocName]').val();var b=$('input[name=C_DocName]').val();var c=$(':checked[name=C_Zoom]').val();var d=$('input[name=C_GrpName]').val();if(a.trim()==''||b.trim()==''||$(':checked[name=C_Zoom]').length==0){alert("다 입력해 주세요.")}else{$.ajax({url:'/data/correct_marker.php',type:'POST',data:{pID:f,LocName:a,DocName:b,Zoom:c,GroupText:d}}).done(function(){location.reload()})}})});$('.del_marker').unbind();$('.del_marker').click(function(){var b=prompt("삭제 사유를 입력해 주십시오.");if(b.replace(/^\s+|\s+$/g,"")!=''){$.ajax({url:'/data/delete_marker.php',type:'POST',data:{pID:f,com:b}}).done(function(a){alert("삭제되었습니다.");location.reload()})}else{alert("사유를 입력해야 합니다.")}})})})}markerleng[j]=o[j].length}});return o}function zoomWithMarkers(a){if(a==null)a=false;var b=map.getZoom();if($('#groupselect').val()!=9999&&a==false)return;if(!a){if(b>=0&&b<=4){if(zoomLevel==1){return}else zoomLevel=1}else if(b>=5&&b<=10){if(zoomLevel==2){return}else zoomLevel=2}else if(b>=11&&b<=15){if(zoomLevel==3){return}else zoomLevel=3}else{if(zoomLevel==4){return}else zoomLevel=4}}for(var i=0;i<markerleng[zoomLevel];i++){markers[zoomLevel][i].setVisible(true)}for(var j=1;j<5;j++){if(j<=zoomLevel)continue;for(var i=0;i<markerleng[j];i++){markers[j][i].setVisible(false)}}}function codeAddress(){var d=document.getElementById('address').value;geocoder.geocode({'address':d},function(a,b){if(b==google.maps.GeocoderStatus.OK){map.setCenter(a[0].geometry.location);var n=a.length;var c=[];alert(+n+'개 결과가 있습니다.');for(var i=0;i<n;++i){c[i]=new google.maps.InfoWindow();c[i].setContent('<b>'+d+'</b>');c[i].setPosition(a[i].geometry.location);c[i].open(map)}}else{if(b=='ZERO_RESULTS'){b="결과가 없습니다."}alert('실패: '+b)}})}function notice(){showeffect();$('#data').html(noticeText)}function recent(){showeffect();var c='<table class="wikitable"><thead><tr><th>구분</th><th>시간</th><th>이름</th><th>원작성자</th></tr></thead><tbody>';$.ajax({url:'/data/log_data.php',dataType:'json',}).done(function(a){for(var i in a){var b;if(a[i].what=='correct'){b='수정'}else if(a[i].what=='delete'){b='삭제'}else if(a[i].what=='register'){b='등록'}c+='<tr><td>'+b+'</td><td>'+a[i].date+'</td><td><a role="button" onclick="tomarker('+a[i].Lat+','+a[i].Lng+')">'+a[i].Ln+'</a></td><td>'+a[i].Name+'</td></tr>'}c+='</tbody></table>';$('#data').html(c)})}function tomarker(a,b){map.setZoom(16);map.setCenter(new google.maps.LatLng(a,b));google.maps.event.trigger(map,'idle')}
